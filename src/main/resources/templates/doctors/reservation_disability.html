<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="#{doctors.reservation_disability.title}">진료 휴무일 설정</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
</head>
<style>
  html, body {
    height: 100%;
    margin: 0;
  }

  body {
    display: flex;
    flex-direction: column;
  }

  .container {
    padding-top: 8rem;
    flex: 1;
  }
</style>
<body class="bg-light">

<div th:replace="fragments/header :: header"></div>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0" th:text="#{doctors.reservation_disability.title}">진료 휴무일 설정</h5>
        </div>
        <div class="card-body">
          <form method="post" th:action="@{/doctors/reservationDisability}" onsubmit="return validateForm()">
            <!-- 날짜 선택 -->
            <div class="mb-4">
              <label class="form-label fw-semibold" th:text="#{doctors.reservation_disability.label.date}">휴무 날짜</label>
              <input type="text" id="datePicker" class="form-control" th:placeholder="#{doctors.reservation_disability.placeholder.date}" required>
              <p class="form-text text-danger small mt-1" th:text="#{doctors.reservation_disability.guide}">※ 이미 등록된 휴무일 및 주말은 선택할 수 없습니다.</p>
            </div>

            <!-- 제출 -->
            <div class="d-grid">
              <button id="submitBtn" type="submit" class="btn btn-danger" th:text="#{doctors.reservation_disability.button.save}">저장하기</button>
            </div>
            <div id="dateContainer"></div>
            <input type="hidden" name="doctorEmail" th:value="${doctor.email}">
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<!-- 스크립트 -->
<script th:inline="javascript">
  const disableDates = '[[${disableDates}]]';
  const msgSelectDate = '[[${msgSelectDate}]]';
  const msgAlreadyDisabled = '[[${msgAlreadyDisabled}]]';
</script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    flatpickr("#datePicker", {
      locale: "ko",
      dateFormat: "Y-m-d",
      minDate: "today",
      disableMobile: true,
      mode: "multiple",
      enableTime: false,
      time_24hr: false,
      utc: false,
      disable: [
        date => {
          const formatted =
            date.getFullYear() + "-" +
            String(date.getMonth() + 1).padStart(2, "0") + "-" +
            String(date.getDate()).padStart(2, "0");

          return disableDates.includes(formatted);
        }
      ],
      onChange: function (selectedDates, dateStr, instance) {
        const selected = instance.selectedDates.map(d =>
          d.getFullYear() + "-" +
          String(d.getMonth() + 1).padStart(2, "0") + "-" +
          String(d.getDate()).padStart(2, "0")
        );

        // hidden input 생성
        const container = document.getElementById("dateContainer");
        container.innerHTML = "";
        selected.forEach(date => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = "dates";
          input.value = date;
          container.appendChild(input);
        });
      }
    });
  });

  function validateForm() {
    const hiddenDates = document.querySelectorAll("input[name='dates']");
    if (hiddenDates.length === 0) {
      alert(msgSelectDate);
      return false;
    }

    // 혹시라도 브라우저 측에서 막지 못한 휴무일이 선택됐는지 재검사
    const selectedDates = Array.from(hiddenDates).map(input => input.value);
    const conflict = selectedDates.find(date => disableDates.includes(date));
    if (conflict) {
      alert(msgAlreadyDisabled.replace('{0}', conflict));
      return false;
    }

    const submitBtn = document.getElementById("submitBtn");
    submitBtn.disabled = true;
    submitBtn.innerText = "Ongoing...";
    document.getElementById("datePicker").disabled = true;

    return true;
  }
</script>

</body>
</html>